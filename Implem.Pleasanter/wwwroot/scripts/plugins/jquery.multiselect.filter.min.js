(function($){var rEscape=/[\-\[\]{}()*+?.,\\\^$|#\s]/g;filterRules={contains:"{{term}}",beginsWith:"^{{term}}",endsWith:"{{term}}$",exactMatch:"^{{term}}$",containsNumber:"d",isNumeric:"^d+$",isNonNumeric:"^D+$"};function debounce(func,wait,immediate){var timeout;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate){func.apply(context,args)}};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow){func.apply(context,args)}}}$.widget("ech.multiselectfilter",{options:{label:"Filter:",placeholder:"Enter keywords",filterRule:"contains",searchGroups:false,autoReset:false,width:null,debounceMS:250},_create:function(){var opts=this.options;var $element=this.element;this.instance=$element.multiselect().data("ech-multiselect");this.$header=this.instance.$menu.find(".ui-multiselect-header").addClass("ui-multiselect-hasfilter");this.$input=$(document.createElement("input")).attr({placeholder:opts.placeholder,type:"search"}).css({width:/\d/.test(opts.width)?opts.width+"px":null}).on({keydown:function(e){if(e.which===13)e.preventDefault();else if(e.which===27){$element.multiselect("close");e.preventDefault()}else if(e.which===9&&e.shiftKey){$element.multiselect("close");e.preventDefault()}else if(e.altKey){switch(e.which){case 82:e.preventDefault();$(this).val("").trigger("input","");break;case 65:$element.multiselect("checkAll");break;case 85:$element.multiselect("uncheckAll");break;case 70:$element.multiselect("flipAll");break;case 76:$element.multiselect("instance").$labels.first().trigger("mouseenter");break}}},input:$.proxy(debounce(this._handler,opts.debounceMS),this),search:$.proxy(this._handler,this)});if(this.options.autoReset)$element.on("multiselectclose",$.proxy(this._reset,this));var $label=$(document.createElement("label")).text(opts.label).append(this.$input);this.$wrapper=$(document.createElement("div")).addClass(" ui-multiselect-filter").append($label).prependTo(this.$header);if(!!this.instance._isOpen){this.instance._setMenuHeight(true)}this.updateCache();var instance=this.instance;var filter=this.$input[0];instance._oldToggleChecked=instance._toggleChecked;instance._toggleChecked=function(flag,group){instance._oldToggleChecked(flag,group,!!filter.value)}},_handler:function(e){var term=this.$input[0].value.toLowerCase().replace(/^\s+|\s+$/g,"");var filterRule=this.options.filterRule||"contains";var regex=new RegExp((filterRules[filterRule]||filterRule).replace("{{term}}",term.replace(rEscape,"\\$&")),"i");var searchGroups=!!this.options.searchGroups;var $checkboxes=this.instance.$checkboxes;var cache=this.cache;var optgroupClass="ui-multiselect-optgroup";var hiddenClass="ui-multiselect-excluded";this.$rows.toggleClass(hiddenClass,!!term);var filteredInputs=$checkboxes.children().map(function(x){var $this=$(this);var $groupItems=$this;var groupShown=false;if($this.hasClass(optgroupClass)){var $groupItems=$this.find("li");if(searchGroups&&regex.test(cache[x])){$this.removeClass(hiddenClass);$groupItems.removeClass(hiddenClass);return $groupItems.find("input").get()}}return $groupItems.map(function(y){var $listItem=$(this);if(regex.test(cache[x+"."+y])){if(!groupShown){$this.removeClass(hiddenClass);groupShown=true}$listItem.removeClass(hiddenClass);return this.getElementsByTagName("input")[0]}return null})});if(term){this._trigger("filter",e,filteredInputs)}if(!this.instance.options.listbox){this.instance._setMenuHeight(true)}return},_reset:function(){this.$input.val("").trigger("input","")},updateCache:function(alsoRefresh){var cache={};this.instance.$checkboxes.children().each(function(x){var $element=$(this);if($element.hasClass("ui-multiselect-optgroup")){cache[x]=$element.children("a").text();$element=$element.find("li")}$element.each(function(y){cache[x+"."+y]=$(this).text()})});this.cache=cache;this.$rows=this.instance.$checkboxes.find("li");if(!!alsoRefresh){this._handler()}},widget:function(){return this.$wrapper},destroy:function(){$.Widget.prototype.destroy.call(this);this.$input.val("").trigger("keyup").off("keydown input search");this.instance.$menu.find(".ui-multiselect-header").removeClass("ui-multiselect-hasfilter");this.$wrapper.remove()}})})(jQuery);
