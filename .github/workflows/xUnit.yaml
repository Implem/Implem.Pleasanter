name: build and xUnit test
on:
  schedule:
    - cron: '0 13 * * *'   # UTC (= 22:00 JST)
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
env:
  AZURE_WEBAPP_NAME: pleasanter
  AZURE_WEBAPP_PACKAGE_PATH: Implem.Pleasanter/publish
  CONFIGURATION: Release
  DOTNET_CORE_VERSION: 6.0.x
  DOTNET_CORE_DIR: net6.0
jobs:
    run_xunit_test:
        name: Run xUnit test
        runs-on: ubuntu-latest
        env:
            Implem_Pleasanter_Rds_PostgreSQL_SaConnectionString: ${{ secrets.PLEASANTER_RDS_SA_CONN }}
            Implem_Pleasanter_Rds_PostgreSQL_OwnerConnectionString: ${{ secrets.PLEASANTER_RDS_OWNER_CONN }}
            Implem_Pleasanter_Rds_PostgreSQL_UserConnectionString: ${{ secrets.PLEASANTER_RDS_USER_CONN }}
            POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
            DOCKER_BUILDKIT: 1
            COMPOSE_DOCKER_CLI_BUILD: true
        steps:
            - uses: actions/checkout@v3
            - name: xUnit Test Started Notification
              uses: mikesprague/teams-incoming-webhook-action@v1
              with:
                github-token: ${{ github.token }}
                webhook-url: ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
                deploy-card: true
                title: "xUnit Test Started"
                color: "info"
            - name: build on docker-compose
              working-directory: ./
              run: docker-compose build Implem.CodeDefiner Implem.PleasanterTest
            - name: run Implem.CodeDefiner on docker-compose
              run: docker-compose run --rm --name codedefiner Implem.CodeDefiner _rds
              working-directory: ./
            - name: run Implem.PleasanterTest on docker-compose
              run: docker-compose run --rm --name testrunner Implem.PleasanterTest
              working-directory: ./
            - name: clean up on docker-compose
              run: docker-compose down
              working-directory: ./
            - name: Cancelled Notification
              if: ${{ cancelled() }}
              uses: mikesprague/teams-incoming-webhook-action@v1
              with:
                github-token: ${{ github.token }}
                webhook-url: ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
                deploy-card: true
                title: "xUnit test Cancelled"
                color: "warning"
            - name: Failure Notification
              if: ${{ failure() }}
              uses: mikesprague/teams-incoming-webhook-action@v1
              with:
                github-token: ${{ github.token }}
                webhook-url: ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
                deploy-card: true
                title: "xUnit test Failed"
                color: "failure"
            - name: Success Notification
              if: ${{ success() }}
              uses: mikesprague/teams-incoming-webhook-action@v1
              with:
                github-token: ${{ github.token }}
                webhook-url: ${{ secrets.MS_TEAMS_WEBHOOK_URL }}
                deploy-card: true
                title: "xUnit test Successful"
                color: "success"
